---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Predictions">
  <div class="space-y-8">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">
        Predictions <span class="text-yellow-400">& Bets</span>
      </h1>
      <p class="text-gray-400 max-w-lg mx-auto">
        Make predictions before and during the match. Right answers earn points!
      </p>
    </div>

    <!-- Current User -->
    <div id="current-user-display" class="text-center text-gray-400">
      Loading...
    </div>

    <!-- Prediction Categories -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Men's Rumble Predictions -->
      <section class="bg-gray-900 rounded-xl p-6 border border-blue-800">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <span class="text-2xl">üëî</span>
          Men's Rumble Predictions
        </h2>
        <p class="text-gray-400 text-sm mb-4">Make your picks for the Men's Royal Rumble</p>

        <div class="space-y-4">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who wins the Men's Rumble?</h4>
            <select id="mens-winner" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who gets Iron Man (longest time)?</h4>
            <select id="mens-ironman" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who gets most eliminations?</h4>
            <select id="mens-elims" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">First elimination?</h4>
            <select id="mens-first-elim" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Final two wrestlers?</h4>
            <div class="grid grid-cols-2 gap-2">
              <select id="mens-final-1" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500 text-sm">
                <option value="">First finalist...</option>
              </select>
              <select id="mens-final-2" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-blue-500 text-sm">
                <option value="">Second finalist...</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Women's Rumble Predictions -->
      <section class="bg-gray-900 rounded-xl p-6 border border-pink-800">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <span class="text-2xl">üëó</span>
          Women's Rumble Predictions
        </h2>
        <p class="text-gray-400 text-sm mb-4">Make your picks for the Women's Royal Rumble</p>

        <div class="space-y-4">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who wins the Women's Rumble?</h4>
            <select id="womens-winner" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who gets Iron Woman (longest time)?</h4>
            <select id="womens-ironwoman" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Who gets most eliminations?</h4>
            <select id="womens-elims" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">First elimination?</h4>
            <select id="womens-first-elim" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500">
              <option value="">Select wrestler...</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Final two wrestlers?</h4>
            <div class="grid grid-cols-2 gap-2">
              <select id="womens-final-1" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500 text-sm">
                <option value="">First finalist...</option>
              </select>
              <select id="womens-final-2" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-pink-500 text-sm">
                <option value="">Second finalist...</option>
              </select>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Surprise Entrants & Special Predictions -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Surprise Entrants -->
      <section class="bg-gray-900 rounded-xl p-6 border border-yellow-800">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <span class="text-2xl">üé≠</span>
          Surprise Entrant Predictions
        </h2>
        <p class="text-gray-400 text-sm mb-4">Which non-WWE wrestlers might show up?</p>

        <div class="space-y-4">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">AEW surprise entrant?</h4>
            <p class="text-gray-400 text-xs mb-2">Will anyone from AEW make a shock appearance?</p>
            <select id="aew-surprise" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-yellow-500">
              <option value="">Select wrestler or "None"...</option>
              <option value="none">No AEW surprise</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">TNA surprise entrant?</h4>
            <p class="text-gray-400 text-xs mb-2">Will anyone from TNA make an appearance?</p>
            <select id="tna-surprise" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-yellow-500">
              <option value="">Select wrestler or "None"...</option>
              <option value="none">No TNA surprise</option>
            </select>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Legend/HOF return?</h4>
            <p class="text-gray-400 text-xs mb-2">Which legend will make a surprise return?</p>
            <select id="legend-return" class="prediction-select w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-yellow-500">
              <option value="">Select legend or "None"...</option>
              <option value="none">No legend return</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Special Predictions -->
      <section class="bg-gray-900 rounded-xl p-6 border border-purple-800">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <span class="text-2xl">üé≤</span>
          Special Predictions
        </h2>
        <p class="text-gray-400 text-sm mb-4">Bold predictions and fun bets</p>

        <div class="space-y-4">
          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Will Entry #27 win either Rumble?</h4>
            <p class="text-gray-400 text-xs mb-2">#27 has historically been the "lucky number"</p>
            <div class="flex gap-2">
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-green-600 hover:text-white" data-prediction="lucky27" data-value="yes">Yes</button>
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white" data-prediction="lucky27" data-value="no">No</button>
            </div>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Will a champion enter the Rumble?</h4>
            <div class="flex gap-2">
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-green-600 hover:text-white" data-prediction="champion-enters" data-value="yes">Yes</button>
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white" data-prediction="champion-enters" data-value="no">No</button>
            </div>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Will there be a celebrity entrant?</h4>
            <div class="flex gap-2">
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-green-600 hover:text-white" data-prediction="celebrity" data-value="yes">Yes</button>
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white" data-prediction="celebrity" data-value="no">No</button>
            </div>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Will CM Punk and Seth Rollins be in the ring together?</h4>
            <div class="flex gap-2">
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-green-600 hover:text-white" data-prediction="punk-seth" data-value="yes">Yes</button>
              <button class="prediction-btn flex-1 py-2 rounded bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white" data-prediction="punk-seth" data-value="no">No</button>
            </div>
          </div>

          <div class="p-4 bg-gray-800 rounded-lg">
            <h4 class="text-white font-medium mb-2">Winning entry number range?</h4>
            <p class="text-gray-400 text-xs mb-2">What range will the winner enter from?</p>
            <div class="grid grid-cols-3 gap-2">
              <button class="prediction-btn py-2 rounded bg-gray-700 text-gray-300 hover:bg-purple-600 hover:text-white text-sm" data-prediction="entry-range" data-value="1-10">#1-10</button>
              <button class="prediction-btn py-2 rounded bg-gray-700 text-gray-300 hover:bg-purple-600 hover:text-white text-sm" data-prediction="entry-range" data-value="11-20">#11-20</button>
              <button class="prediction-btn py-2 rounded bg-gray-700 text-gray-300 hover:bg-purple-600 hover:text-white text-sm" data-prediction="entry-range" data-value="21-30">#21-30</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- During-Match Section -->
    <div class="grid md:grid-cols-1 gap-6">

      <!-- During-Match Predictions -->
      <section class="bg-gray-900 rounded-xl p-6 border border-gray-800">
        <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
          <span class="text-2xl">üç∫</span>
          Drinking Game / Live Bets
        </h2>
        <p class="text-gray-400 text-sm mb-4">Call these during the match for fun!</p>

        <div class="space-y-3">
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">ü¶∂</span>
            <div>
              <div class="text-white font-medium">Kofi Save</div>
              <div class="text-gray-400 text-xs">Someone saves themselves from elimination creatively</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">üë¥</span>
            <div>
              <div class="text-white font-medium">Legend Surprise</div>
              <div class="text-gray-400 text-xs">A Hall of Famer or legend makes a surprise return</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">üëπ</span>
            <div>
              <div class="text-white font-medium">Monster Entrance</div>
              <div class="text-gray-400 text-xs">Everyone stops fighting when a big wrestler enters</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">üëÄ</span>
            <div>
              <div class="text-white font-medium">The Staredown</div>
              <div class="text-gray-400 text-xs">Two wrestlers have a dramatic face-off</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">üò§</span>
            <div>
              <div class="text-white font-medium">Sore Loser</div>
              <div class="text-gray-400 text-xs">Eliminated wrestler returns to attack someone</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">ü§ù</span>
            <div>
              <div class="text-white font-medium">Enemy Mine</div>
              <div class="text-gray-400 text-xs">Rivals team up to eliminate a bigger threat</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">‚ö°</span>
            <div>
              <div class="text-white font-medium">Quick Exit</div>
              <div class="text-gray-400 text-xs">Someone eliminated in under 10 seconds</div>
            </div>
          </button>
          <button class="trope-btn w-full p-3 bg-gray-800 rounded-lg text-left hover:bg-gray-700 transition-colors flex items-center gap-3">
            <span class="text-2xl">üèÜ</span>
            <div>
              <div class="text-white font-medium">Champion Enters</div>
              <div class="text-gray-400 text-xs">A current champion participates in the Rumble</div>
            </div>
          </button>
        </div>

        <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-600 rounded-lg">
          <p class="text-yellow-400 text-sm">
            <strong>Drinking Rules:</strong> Take a drink every time one of these happens!
            Or assign points for being the first to call it.
          </p>
        </div>
      </section>
    </div>

    <!-- Your Predictions Summary -->
    <section class="bg-gray-900 rounded-xl p-6 border border-gray-800">
      <h2 class="text-xl font-semibold text-white mb-4">Your Predictions</h2>
      <div id="predictions-summary" class="text-gray-400">
        No predictions made yet. Select options above!
      </div>
    </section>
  </div>
</Layout>

<style>
  .prediction-btn.selected {
    box-shadow: 0 0 0 2px #a855f7;
  }
</style>

<script>
  import { initCurrentUser, $currentUser, $wrestlers } from '../stores/matchStore';

  // Initialize current user
  initCurrentUser();

  // Display current user
  function updateUserDisplay() {
    const display = document.getElementById('current-user-display');
    if (!display) return;

    const user = $currentUser.get();
    if (user) {
      display.innerHTML = `
        <span class="text-white font-medium">Making predictions as: ${user.name}</span>
        <a href="/" class="text-purple-400 hover:underline text-sm ml-2">(change)</a>
      `;
    } else {
      display.innerHTML = `
        <span class="text-yellow-400">Please <a href="/" class="underline">select your name</a> first</span>
      `;
    }
  }

  $currentUser.subscribe(updateUserDisplay);
  updateUserDisplay();

  // Populate wrestler selects
  const wrestlers = $wrestlers.get();
  const maleWrestlers = wrestlers.filter(w => w.gender === 'male').sort((a, b) => a.name.localeCompare(b.name));
  const femaleWrestlers = wrestlers.filter(w => w.gender === 'female').sort((a, b) => a.name.localeCompare(b.name));
  const aewWrestlers = wrestlers.filter(w => w.promotion === 'AEW').sort((a, b) => a.name.localeCompare(b.name));
  const tnaWrestlers = wrestlers.filter(w => w.promotion === 'TNA').sort((a, b) => a.name.localeCompare(b.name));
  const legends = wrestlers.filter(w => w.isLegend || w.isHallOfFamer).sort((a, b) => a.name.localeCompare(b.name));

  // Helper to add options to a select
  function populateSelect(selectId: string, wrestlerList: typeof wrestlers, showBadges = true) {
    const select = document.getElementById(selectId) as HTMLSelectElement;
    if (!select) return;

    wrestlerList.forEach(w => {
      const option = document.createElement('option');
      option.value = w.id;
      let label = w.name;
      if (showBadges) {
        if (w.isCurrentChampion) label += ' (Champion)';
        if (w.isFormerRumbleWinner) label += ' (RR Winner)';
        if (w.isHallOfFamer) label += ' (HOF)';
      }
      option.textContent = label;
      select.appendChild(option);
    });
  }

  // Men's Rumble selects
  ['mens-winner', 'mens-ironman', 'mens-elims', 'mens-first-elim', 'mens-final-1', 'mens-final-2'].forEach(id => {
    populateSelect(id, maleWrestlers);
  });

  // Women's Rumble selects
  ['womens-winner', 'womens-ironwoman', 'womens-elims', 'womens-first-elim', 'womens-final-1', 'womens-final-2'].forEach(id => {
    populateSelect(id, femaleWrestlers);
  });

  // Surprise entrant selects
  populateSelect('aew-surprise', aewWrestlers);
  populateSelect('tna-surprise', tnaWrestlers);
  populateSelect('legend-return', legends);

  // Handle prediction button clicks
  document.querySelectorAll('.prediction-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const prediction = (btn as HTMLElement).dataset.prediction;
      const value = (btn as HTMLElement).dataset.value;

      // Remove selected from siblings
      document.querySelectorAll(`[data-prediction="${prediction}"]`).forEach(b => {
        b.classList.remove('selected', 'bg-green-600', 'bg-red-600', 'bg-purple-600', 'text-white');
        b.classList.add('bg-gray-700', 'text-gray-300');
      });

      // Add selected to this one
      const colorClass = value === 'yes' ? 'bg-green-600' : value === 'no' ? 'bg-red-600' : 'bg-purple-600';
      btn.classList.add('selected', colorClass, 'text-white');
      btn.classList.remove('bg-gray-700', 'text-gray-300');

      savePredictions();
      updatePredictionsSummary();
    });
  });

  // Save predictions to localStorage
  function savePredictions() {
    const user = $currentUser.get();
    if (!user) return;

    const predictions: Record<string, string> = {};

    // Save all select values
    document.querySelectorAll('.prediction-select').forEach(select => {
      const el = select as HTMLSelectElement;
      if (el.value) {
        predictions[el.id] = el.value;
      }
    });

    // Save all button predictions
    document.querySelectorAll('.prediction-btn.selected').forEach(btn => {
      const el = btn as HTMLElement;
      if (el.dataset.prediction && el.dataset.value) {
        predictions[el.dataset.prediction] = el.dataset.value;
      }
    });

    localStorage.setItem(`predictions-${user.id}`, JSON.stringify(predictions));
  }

  // Load predictions from localStorage
  function loadPredictions() {
    const user = $currentUser.get();
    if (!user) return;

    const saved = localStorage.getItem(`predictions-${user.id}`);
    if (!saved) return;

    const predictions = JSON.parse(saved);

    // Restore select values
    Object.entries(predictions).forEach(([key, value]) => {
      const select = document.getElementById(key) as HTMLSelectElement;
      if (select) {
        select.value = value as string;
      } else {
        // It's a button prediction
        const btn = document.querySelector(`[data-prediction="${key}"][data-value="${value}"]`) as HTMLElement;
        if (btn) {
          btn.click();
        }
      }
    });

    updatePredictionsSummary();
  }

  // Update predictions summary
  function updatePredictionsSummary() {
    const summary = document.getElementById('predictions-summary');
    if (!summary) return;

    const predictions: string[] = [];

    // Helper to get wrestler name
    const getName = (id: string) => wrestlers.find(w => w.id === id)?.name || id;

    // Men's predictions
    const mensWinner = (document.getElementById('mens-winner') as HTMLSelectElement)?.value;
    if (mensWinner) predictions.push(`Men's Winner: ${getName(mensWinner)}`);

    const mensIronman = (document.getElementById('mens-ironman') as HTMLSelectElement)?.value;
    if (mensIronman) predictions.push(`Men's Iron Man: ${getName(mensIronman)}`);

    const mensElims = (document.getElementById('mens-elims') as HTMLSelectElement)?.value;
    if (mensElims) predictions.push(`Men's Most Eliminations: ${getName(mensElims)}`);

    // Women's predictions
    const womensWinner = (document.getElementById('womens-winner') as HTMLSelectElement)?.value;
    if (womensWinner) predictions.push(`Women's Winner: ${getName(womensWinner)}`);

    const womensIronwoman = (document.getElementById('womens-ironwoman') as HTMLSelectElement)?.value;
    if (womensIronwoman) predictions.push(`Women's Iron Woman: ${getName(womensIronwoman)}`);

    const womensElims = (document.getElementById('womens-elims') as HTMLSelectElement)?.value;
    if (womensElims) predictions.push(`Women's Most Eliminations: ${getName(womensElims)}`);

    // Surprise entrants
    const aewSurprise = (document.getElementById('aew-surprise') as HTMLSelectElement)?.value;
    if (aewSurprise) predictions.push(`AEW Surprise: ${aewSurprise === 'none' ? 'None' : getName(aewSurprise)}`);

    const tnaSurprise = (document.getElementById('tna-surprise') as HTMLSelectElement)?.value;
    if (tnaSurprise) predictions.push(`TNA Surprise: ${tnaSurprise === 'none' ? 'None' : getName(tnaSurprise)}`);

    // Button predictions
    const lucky27 = document.querySelector('[data-prediction="lucky27"].selected') as HTMLElement;
    if (lucky27) predictions.push(`Lucky #27 wins: ${lucky27.dataset.value === 'yes' ? 'Yes' : 'No'}`);

    const championEnters = document.querySelector('[data-prediction="champion-enters"].selected') as HTMLElement;
    if (championEnters) predictions.push(`Champion enters: ${championEnters.dataset.value === 'yes' ? 'Yes' : 'No'}`);

    const celebrity = document.querySelector('[data-prediction="celebrity"].selected') as HTMLElement;
    if (celebrity) predictions.push(`Celebrity entrant: ${celebrity.dataset.value === 'yes' ? 'Yes' : 'No'}`);

    const entryRange = document.querySelector('[data-prediction="entry-range"].selected') as HTMLElement;
    if (entryRange) predictions.push(`Winner entry range: ${entryRange.dataset.value}`);

    if (predictions.length === 0) {
      summary.innerHTML = '<p class="text-gray-400">No predictions made yet. Select options above!</p>';
    } else {
      summary.innerHTML = `
        <div class="grid sm:grid-cols-2 gap-2">
          ${predictions.map(p => `<div class="text-white text-sm">‚Ä¢ ${p}</div>`).join('')}
        </div>
      `;
    }
  }

  // Listen for select changes
  document.querySelectorAll('.prediction-select').forEach(select => {
    select.addEventListener('change', () => {
      savePredictions();
      updatePredictionsSummary();
    });
  });

  // Load saved predictions when user changes
  $currentUser.subscribe(() => {
    setTimeout(loadPredictions, 100);
  });
  setTimeout(loadPredictions, 100);
</script>
